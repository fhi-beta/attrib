<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to Attrib â€¢ attrib</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Attrib">
<meta property="og:description" content="attrib">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">attrib</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2020.7.28</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to Attrib</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to Attrib</h1>
                        <h4 class="author">Aurora Hofman</h4>
            
            <h4 class="date">2020-07-21</h4>
      
      
      <div class="hidden name"><code>intro.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">attrib</span>)
<span class="co">#&gt; PACKAGE: attrib</span>
<span class="co">#&gt; Version: 2020.07.28 at 06:05</span></pre></body></html></div>
<div id="introduciton" class="section level1">
<h1 class="hasAnchor">
<a href="#introduciton" class="anchor"></a>Introduciton</h1>
<p>Attrib provides a way of estimating what the mortality would have been if some given exposures are set to a referance value. By using simulations from the posterior distribution of all coefficiants one gets the opportunity to easily aggregate over time and locations and still be able to optain credible intevals of the desired percentages.</p>
<p>This example will go throug how to use fit_attrib to fit the data, how to use est_attrib to estimate the mortality given exposures and referance values and some examples of usages of the resulting dataset.</p>
<div id="data-example" class="section level2">
<h2 class="hasAnchor">
<a href="#data-example" class="anchor"></a>Data example</h2>
<p>We will use the datasets fake_data_county and fake_data_nation. Fake_data_county consists of fake date of mortalities for all counties of Norway on a weekly basis from 2010 untill 2020. The dataset consists of the followig features:</p>
<ul>
<li>location_code: Location code of the differend counties</li>
<li>week: Week number</li>
<li>season: Years of the season</li>
<li>year: Year</li>
<li>yrwk: Year and week</li>
<li>x: Number of weeks from the start of the season</li>
<li>pop: Population size</li>
<li>pr100_ili: Percentage of doctorsconsultations diagnosed with influenza like ilnesses</li>
<li>pr100_ili_lag_1: pr_100_ili lagged wiht one week</li>
<li>temperature: Temperature</li>
<li>temperature_high: number of heatwaves</li>
<li>deaths: number of mortalities</li>
</ul>
<p>Fake_data_nation consists of the same features but contains national information.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">data_fake_county</span> <span class="kw">&lt;-</span> <span class="kw pkg">attrib</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/attrib/man/data_fake_county.html">data_fake_county</a></span>
<span class="no">data_fake_nation</span> <span class="kw">&lt;-</span> <span class="kw pkg">attrib</span><span class="kw ns">::</span><span class="no"><a href="https://rdrr.io/pkg/attrib/man/data_fake_nation.html">data_fake_nation</a></span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data_fake_county</span>, <span class="fl">5</span>)
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 1.9011202</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.9246802</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.1543753</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.3947382</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.7962545</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths</span>
<span class="co">#&gt; 1:       1.8916383  2.39975858                0    108</span>
<span class="co">#&gt; 2:       0.7129761  1.90199543                0    104</span>
<span class="co">#&gt; 3:       0.9264079 -6.82610667                0    107</span>
<span class="co">#&gt; 4:       1.1649833 -4.28041946                0    117</span>
<span class="co">#&gt; 5:       1.6253183  0.07310006                0    113</span></pre></body></html></div>
<p>In this example we will look at the exposures pr100_ili_lag_1 and temperature_high and calculate the attributable mortalities due to these exposures.</p>
</div>
</div>
<div id="fitting-using-fit_attrib" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-using-fit_attrib" class="anchor"></a>Fitting using fit_attrib</h1>
<div id="county-level" class="section level2">
<h2 class="hasAnchor">
<a href="#county-level" class="anchor"></a>County level</h2>
<p>We want to estimate the attributable mortality due to ILI and heatwaves. Attrib lets us fit models with both fixed and random effect and offsets using linear mixed models. To do so the glmer function from lme4 package is used. This means we must specify which are the offsets, the fixed effects and the random effects. We must also spesify the response. In our case we will model the response <em>deaths</em> as a function of:</p>
<ul>
<li>the fixed effects:
<ul>
<li>temperature_high</li>
<li>pr100_ili_lag_1</li>
<li>sin(2 * pi * (week - 1) / 52)</li>
<li>cos(2 * pi * (week - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(1|location_code)</li>
<li>(pr100_ili_lag_1|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co">#response</span>
<span class="no">response</span> <span class="kw">&lt;-</span> <span class="st">"deaths"</span>

<span class="co"># fixed effects</span>
<span class="no">fixef_county</span> <span class="kw">&lt;-</span> <span class="st">" temperature_high +
  pr100_ili_lag_1 +
  sin(2 * pi * (week - 1) / 52) +
  cos(2 * pi * (week - 1) / 52)"</span>


<span class="co">#random effects</span>
<span class="no">ranef_county</span> <span class="kw">&lt;-</span> <span class="st">"(1|location_code) +
  (pr100_ili_lag_1|season)"</span>

<span class="co">#offset</span>
<span class="no">offset_county</span> <span class="kw">&lt;-</span> <span class="st">"log(pop)"</span></pre></body></html></div>
<p>Now we fit the model using fit_attrib.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r">
<span class="no">fit_county</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/attrib/man/fit_attrib.html">fit_attrib</a></span>(<span class="no">data_fake_county</span>,
                          <span class="kw">response</span> <span class="kw">=</span> <span class="no">response</span>,
                          <span class="kw">fixef</span> <span class="kw">=</span> <span class="no">fixef_county</span>,
                          <span class="kw">ranef</span> <span class="kw">=</span> <span class="no">ranef_county</span>,
                          <span class="kw">offset</span> <span class="kw">=</span> <span class="no">offset_county</span>)</pre></body></html></div>
<p>This results in the following fit.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">fit_county</span>
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: poisson  ( log )</span>
<span class="co">#&gt; Formula: deaths ~ temperature_high + pr100_ili_lag_1 + sin(2 * pi * (week -  </span>
<span class="co">#&gt;     1)/52) + cos(2 * pi * (week - 1)/52) + offset(log(pop)) +  </span>
<span class="co">#&gt;     (1 | location_code) + (pr100_ili_lag_1 | season)</span>
<span class="co">#&gt;    Data: data</span>
<span class="co">#&gt;       AIC       BIC    logLik  deviance  df.resid </span>
<span class="co">#&gt;  44427.85  44488.60 -22204.92  44409.85      6305 </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups        Name            Std.Dev. Corr </span>
<span class="co">#&gt;  season        (Intercept)     0.003392      </span>
<span class="co">#&gt;                pr100_ili_lag_1 0.003634 -0.89</span>
<span class="co">#&gt;  location_code (Intercept)     0.000000      </span>
<span class="co">#&gt; Number of obs: 6314, groups:  season, 12; location_code, 11</span>
<span class="co">#&gt; Fixed Effects:</span>
<span class="co">#&gt;                 (Intercept)             temperature_high  </span>
<span class="co">#&gt;                    -8.80487                      0.08337  </span>
<span class="co">#&gt;             pr100_ili_lag_1  sin(2 * pi * (week - 1)/52)  </span>
<span class="co">#&gt;                     0.03828                      0.01821  </span>
<span class="co">#&gt; cos(2 * pi * (week - 1)/52)  </span>
<span class="co">#&gt;                     0.06821  </span>
<span class="co">#&gt; convergence code 0; 0 optimizer warnings; 1 lme4 warnings</span></pre></body></html></div>
<p>Note that fit has the added attributes offset, saving the offset name, and fit_fix, the coefficients of the linear model fitted on only the fixed effects. These are needed by est_attrib later on to create the dataset containing only the fixed effects.</p>
</div>
<div id="national-level" class="section level2">
<h2 class="hasAnchor">
<a href="#national-level" class="anchor"></a>National level</h2>
<p>We estimate the same as before But on a national level, meaning we remove the random effect (1|location_code) sinse we only have one location code. This gives the following features:</p>
<ul>
<li>the fixed effects:
<ul>
<li>temperature_high</li>
<li>pr100_ili_lag_1</li>
<li>sin(2 * pi * (week - 1) / 52)</li>
<li>cos(2 * pi * (week - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(pr100_ili_lag_1|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># take in the fixed effects</span>
<span class="no">response</span> <span class="kw">=</span> <span class="st">"deaths"</span>
<span class="no">fixef_nation</span> <span class="kw">&lt;-</span> <span class="st">"temperature_high +
  pr100_ili_lag_1 +
  sin(2 * pi * (week - 1) / 52) +
  cos(2 * pi * (week - 1) / 52)"</span>


<span class="co">#take in the random effects</span>
<span class="no">ranef_nation</span> <span class="kw">&lt;-</span> <span class="st">"(pr100_ili_lag_1|season)"</span>

<span class="co"># take in the offset</span>
<span class="no">offset_nation</span> <span class="kw">&lt;-</span> <span class="st">"log(pop)"</span></pre></body></html></div>
<div class="sourceCode" id="cb7"><html><body><pre class="r">
  <span class="no">fit_nation</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/attrib/man/fit_attrib.html">fit_attrib</a></span>(<span class="no">data_fake_nation</span>,
                           <span class="kw">response</span> <span class="kw">=</span> <span class="no">response</span>,
                           <span class="kw">fixef</span> <span class="kw">=</span> <span class="no">fixef_nation</span>,
                           <span class="kw">ranef</span> <span class="kw">=</span> <span class="no">ranef_nation</span>,
                           <span class="kw">offset</span> <span class="kw">=</span> <span class="no">offset_nation</span>)</pre></body></html></div>
</div>
</div>
<div id="using-the-sim-function" class="section level1">
<h1 class="hasAnchor">
<a href="#using-the-sim-function" class="anchor"></a>Using the sim function</h1>
<p>The sim function can be used to generate simulations for all the rows in our data. It first generater 500 simulations from the posterior distribution of the coefficients from out fit before applying these coefficiants on our dataset generating 500 simululations og expected mortality for each line. This is quite generic. Hence if the goal is to compute attributable mortalities or incident risk ratios we use est_attrib as shown below.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">sim_data &lt;- sim(fit_nation, data_fake_nation)
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">sim_data</span>[<span class="no">id_row</span> <span class="kw">==</span> <span class="fl">1</span>], <span class="fl">5</span>)
<span class="co">#&gt;    location_code week    season year    yrwk  x     pop pr100_ili</span>
<span class="co">#&gt; 1:        norway    1 2009/2010 2010 2010-01 24 5367580  1.929324</span>
<span class="co">#&gt; 2:        norway    1 2009/2010 2010 2010-01 24 5367580  1.929324</span>
<span class="co">#&gt; 3:        norway    1 2009/2010 2010 2010-01 24 5367580  1.929324</span>
<span class="co">#&gt; 4:        norway    1 2009/2010 2010 2010-01 24 5367580  1.929324</span>
<span class="co">#&gt; 5:        norway    1 2009/2010 2010 2010-01 24 5367580  1.929324</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths id_row sim_id</span>
<span class="co">#&gt; 1:        1.919701   -3.913114                0    942      1      1</span>
<span class="co">#&gt; 2:        1.919701   -3.913114                0    942      1      2</span>
<span class="co">#&gt; 3:        1.919701   -3.913114                0    942      1      3</span>
<span class="co">#&gt; 4:        1.919701   -3.913114                0    942      1      4</span>
<span class="co">#&gt; 5:        1.919701   -3.913114                0    942      1      5</span>
<span class="co">#&gt;    expected_mort</span>
<span class="co">#&gt; 1:      903.9820</span>
<span class="co">#&gt; 2:      924.9666</span>
<span class="co">#&gt; 3:      943.2720</span>
<span class="co">#&gt; 4:      881.7076</span>
<span class="co">#&gt; 5:      922.0911</span></pre></body></html></div>
<p>We can see that we now have multiple expected mortalities for the same dataline. This is due to the coefficiant simmulations.</p>
</div>
<div id="estimating-referance-mortality-using-est_attrib" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-referance-mortality-using-est_attrib" class="anchor"></a>Estimating referance mortality using est_attrib</h1>
<p>To generate simulations for each observation and estimate the mortality given the referance values of the exposures we use attribs est_attrib. We need to give the fit, the dataset and the exposures with referance values. Est_attrib will then using the sim function from the arm pachage to generate simulations of the underlying posterior distribution before using this to compute the estimated mortalities for each simulation.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r">exposures &lt;- list( "temperature_high" = 0, "pr100_ili_lag_1" = 0)
est_attrib_sim_county &lt;- attrib::est_attrib(fit_county, 
                                        data_fake_county, 
                                        exposures = exposures)
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%
est_attrib_sim_nation &lt;- attrib::est_attrib(fit_nation, 
                                        data_fake_nation, 
                                        exposures = exposures )
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |======================================================================| 100%</pre></body></html></div>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">est_attrib_sim_county</span>, <span class="fl">5</span>)
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 1.9011202</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.9246802</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.1543753</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.3947382</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.7962545</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths id sim_id</span>
<span class="co">#&gt; 1:       1.8916383  2.39975858                0    108  1      1</span>
<span class="co">#&gt; 2:       0.7129761  1.90199543                0    104  2      1</span>
<span class="co">#&gt; 3:       0.9264079 -6.82610667                0    107  3      1</span>
<span class="co">#&gt; 4:       1.1649833 -4.28041946                0    117  4      1</span>
<span class="co">#&gt; 5:       1.6253183  0.07310006                0    113  5      1</span>
<span class="co">#&gt;    exp_mort_observed exp_mort_temperature_high=0 exp_mort_pr100_ili_lag_1=0</span>
<span class="co">#&gt; 1:          119.4935                    119.4935                   110.3565</span>
<span class="co">#&gt; 2:          113.8407                    113.8407                   111.0956</span>
<span class="co">#&gt; 3:          115.5584                    115.5584                   111.5230</span>
<span class="co">#&gt; 4:          116.2892                    116.2892                   110.8214</span>
<span class="co">#&gt; 5:          118.2408                    118.2408                   110.3658</span></pre></body></html></div>
<p>Now we can see in the above dataset that the colums <em>id</em>, <em>sim_id</em>, <em>exp_mort_observed</em>, <em>exp_mort_temperature_high=0</em>, <em>exp_mort_pr100_ili_lag_1=0</em> are added to the previous set of colums. For each row in the original dataset we now have 500 <!-- change this if we change n_sim --> rows, one for each of the simulations done by est_attrib. In each row we see the estimate of the number of mortalities given a refereance value for <em>exp_mort_temperature_high</em> and <em>exp_mort_pr100_ili_lag_1</em>.</p>
<p>To make the dataprocessing easier later we convert the dataset from wide to long form and collapse the estimated mortalities</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">est_attrib_county_long</span><span class="kw">&lt;-</span><span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt.data.table</a></span>(<span class="no">est_attrib_sim_county</span>,
                                                  <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"location_code"</span>,
                                                              <span class="st">"season"</span>,
                                                              <span class="st">"x"</span>,
                                                              <span class="st">"week"</span>,
                                                              <span class="st">"id"</span>,
                                                              <span class="st">"sim_id"</span>,
                                                              <span class="st">"deaths"</span>,
                                                              <span class="st">"exp_mort_observed"</span>),
                                           <span class="kw">measure.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_mort_temperature_high=0"</span>,
                                                            <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>))
<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span>(<span class="no">est_attrib_county_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">est_attrib_county_long</span>, <span class="fl">5</span>)
<span class="co">#&gt;    location_code    season  x week id sim_id deaths exp_mort_observed</span>
<span class="co">#&gt; 1:      county03 2009/2010 24    1  1      1    108          119.4935</span>
<span class="co">#&gt; 2:      county03 2010/2011 24    1  2      1    104          113.8407</span>
<span class="co">#&gt; 3:      county03 2011/2012 24    1  3      1    107          115.5584</span>
<span class="co">#&gt; 4:      county03 2012/2013 24    1  4      1    117          116.2892</span>
<span class="co">#&gt; 5:      county03 2013/2014 24    1  5      1    113          118.2408</span>
<span class="co">#&gt;                           attr    value</span>
<span class="co">#&gt; 1: exp_mort_temperature_high=0 119.4935</span>
<span class="co">#&gt; 2: exp_mort_temperature_high=0 113.8407</span>
<span class="co">#&gt; 3: exp_mort_temperature_high=0 115.5584</span>
<span class="co">#&gt; 4: exp_mort_temperature_high=0 116.2892</span>
<span class="co">#&gt; 5: exp_mort_temperature_high=0 118.2408</span></pre></body></html></div>
<p>We can see that the columns <em>exp_mort_temperature_high=0</em>, <em>exp_mort_pr100_ili_lag_1=0</em> are now collapsed into the new column <em>attr</em> and <em>value</em> with <em>attr</em> discribing which exposure we have and <em>value</em> giving the corresponding referance value.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">est_attrib_nation_long</span><span class="kw">&lt;-</span><span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt.data.table</a></span>(<span class="no">est_attrib_sim_nation</span>,
                                                  <span class="kw">id.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"location_code"</span>,
                                                              <span class="st">"season"</span>,
                                                              <span class="st">"x"</span>,
                                                              <span class="st">"week"</span>,
                                                              <span class="st">"id"</span>,
                                                              <span class="st">"sim_id"</span>,
                                                              <span class="st">"deaths"</span>,
                                                              <span class="st">"exp_mort_observed"</span>),
                                           <span class="kw">measure.vars</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_mort_temperature_high=0"</span>,
                                                            <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>))
<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span>(<span class="no">est_attrib_nation_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span>)</pre></body></html></div>
</div>
<div id="compare-the-national-data-to-data-aggregated-from-county-to-national-level-" class="section level1">
<h1 class="hasAnchor">
<a href="#compare-the-national-data-to-data-aggregated-from-county-to-national-level-" class="anchor"></a>Compare the national data to data aggregated from county to national level.</h1>
<p>Sinse we now have two datasets, one on a countylevel and one on a national level, to compare them some aggregations is needed.</p>
<div id="aggregate-from-county-to-national-level-seasonaly" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregate-from-county-to-national-level-seasonaly" class="anchor"></a>Aggregate from county to national level seasonaly</h2>
<p>To aggregate from the the current dataset to a national dataset with seasonal data for <em>est_attrib_county_long</em>, the county dataset, we sums <em>exp_mort_observed</em>, <em>value</em> and <em>deaths</em> for all counties and weeks per season. Afterwards we calculate the expected attributable mortality, exp_attr, by substracting <em>value</em> (the estimated number of mortalities given the referance value of the exposure) from <em>the exp_mort_observed</em> and the incident risk ration, exp_irr, by deviding <em>exp_mort_observed</em> by <em>value</em>. To be able to separate this dataset from the other we add a tag.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">aggregated_county_to_nation</span> <span class="kw">&lt;-</span>  <span class="no">est_attrib_county_long</span>[,<span class="fu">.</span>(
  <span class="kw">exp_mort_observed</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">exp_mort_observed</span>),
  <span class="kw">value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">value</span>),
  <span class="kw">deaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">deaths</span>)
), <span class="kw">keyby</span> <span class="kw">=</span> <span class="fu">.</span>(<span class="no">season</span>, <span class="no">attr</span>, <span class="no">sim_id</span>)]

<span class="co"># Add exp_attr, exp_irr and a tag.</span>
<span class="no">aggregated_county_to_nation</span>[, <span class="no">exp_attr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span> - <span class="no">value</span>)]
<span class="no">aggregated_county_to_nation</span>[, <span class="no">exp_irr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span>/<span class="no">value</span>)]
<span class="no">aggregated_county_to_nation</span>[, <span class="no">tag</span> <span class="kw">:=</span> <span class="st">"aggregated_from_county"</span>]

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_county_to_nation</span>, <span class="fl">5</span>)
<span class="co">#&gt;       season                        attr sim_id exp_mort_observed    value</span>
<span class="co">#&gt; 1: 2009/2010 exp_mort_temperature_high=0      1          25063.61 24864.64</span>
<span class="co">#&gt; 2: 2009/2010 exp_mort_temperature_high=0      2          25394.56 25202.38</span>
<span class="co">#&gt; 3: 2009/2010 exp_mort_temperature_high=0      3          25169.28 24967.10</span>
<span class="co">#&gt; 4: 2009/2010 exp_mort_temperature_high=0      4          25113.88 24914.13</span>
<span class="co">#&gt; 5: 2009/2010 exp_mort_temperature_high=0      5          25182.17 24988.85</span>
<span class="co">#&gt;    deaths exp_attr  exp_irr                    tag</span>
<span class="co">#&gt; 1:  25481 198.9697 1.008002 aggregated_from_county</span>
<span class="co">#&gt; 2:  25481 192.1882 1.007626 aggregated_from_county</span>
<span class="co">#&gt; 3:  25481 202.1771 1.008098 aggregated_from_county</span>
<span class="co">#&gt; 4:  25481 199.7528 1.008018 aggregated_from_county</span>
<span class="co">#&gt; 5:  25481 193.3168 1.007736 aggregated_from_county</span></pre></body></html></div>
<p>We can see that we no longer have the colums <em>location_code</em>, <em>week</em> and <em>x</em> sinse the data is now aggregated to a national level on a seasonal basis.</p>
</div>
<div id="aggregating-the-national-model-per-season" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregating-the-national-model-per-season" class="anchor"></a>Aggregating the national model per season</h2>
<p>For the national model we sum the same feathures but only for all weeks per season and create exp_attr and exp_irr in the same way as above.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">aggregated_nation</span> <span class="kw">&lt;-</span>  <span class="no">est_attrib_nation_long</span>[, <span class="fu">.</span>(
  <span class="kw">exp_mort_observed</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">exp_mort_observed</span>),
  <span class="kw">value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">value</span>),
  <span class="kw">deaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">deaths</span>)
), <span class="kw">keyby</span> <span class="kw">=</span> <span class="fu">.</span>(<span class="no">season</span>, <span class="no">attr</span>, <span class="no">sim_id</span>)]



<span class="no">aggregated_nation</span>[, <span class="no">exp_attr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span> - <span class="no">value</span>)]
<span class="no">aggregated_nation</span>[, <span class="no">exp_irr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span>/<span class="no">value</span>)]
<span class="no">aggregated_nation</span>[, <span class="no">tag</span><span class="kw">:=</span> <span class="st">"nation"</span>]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_nation</span>, <span class="fl">5</span>)
<span class="co">#&gt;       season                        attr sim_id exp_mort_observed    value</span>
<span class="co">#&gt; 1: 2009/2010 exp_mort_temperature_high=0      1          24768.31 24710.38</span>
<span class="co">#&gt; 2: 2009/2010 exp_mort_temperature_high=0      2          25474.31 25413.91</span>
<span class="co">#&gt; 3: 2009/2010 exp_mort_temperature_high=0      3          24675.88 24613.49</span>
<span class="co">#&gt; 4: 2009/2010 exp_mort_temperature_high=0      4          24068.41 24010.57</span>
<span class="co">#&gt; 5: 2009/2010 exp_mort_temperature_high=0      5          24714.86 24651.84</span>
<span class="co">#&gt;    deaths exp_attr  exp_irr    tag</span>
<span class="co">#&gt; 1:  24846 57.92520 1.002344 nation</span>
<span class="co">#&gt; 2:  24846 60.40291 1.002377 nation</span>
<span class="co">#&gt; 3:  24846 62.38773 1.002535 nation</span>
<span class="co">#&gt; 4:  24846 57.83819 1.002409 nation</span>
<span class="co">#&gt; 5:  24846 63.01947 1.002556 nation</span></pre></body></html></div>
<p>Again we kan see that the data does no longer contain weekly information but is aggregated to a seasonal basis.</p>
<p>For simplicity we rbindlist the two datasets together.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="no">data_national</span><span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">aggregated_county_to_nation</span>, <span class="no">aggregated_nation</span>))</pre></body></html></div>
</div>
<div id="calculate-simulation-quantiles-" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-simulation-quantiles-" class="anchor"></a>Calculate simulation quantiles.</h2>
<p>The next thing to do is to aggregate away the simulations. The benefits of having the simulations is the posibility it gives to efficiently compute al desireable quantiles. For this example we will ue the .05, .5 and .95 quantiles.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="co"># Quantile functins</span>
<span class="no">q05</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>){
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">x</span>, <span class="fl">0.05</span>))
}
<span class="no">q95</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>){
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">x</span>, <span class="fl">0.95</span>))
}</pre></body></html></div>
<p>We compute the quantiles for <em>exp_attr</em> and <em>exp_irr</em> in the following way.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">col_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">data_national</span>)
<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span>(<span class="no">data_national</span>,
                    <span class="no">col_names</span>[!<span class="no">col_names</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_attr"</span>,
                                                <span class="st">"exp_irr"</span>,
                                                <span class="st">"sim_id"</span>,
                                                <span class="st">"exp_mort_observed"</span>,
                                                <span class="st">"value"</span>,
                                                <span class="st">"deaths"</span>)])

<span class="no">aggregated_sim_seasonal_data_national</span><span class="kw">&lt;-</span> <span class="no">data_national</span>[,
                                   <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                          <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu">.</span>(<span class="kw">median</span> <span class="kw">=</span> <span class="no">median</span>, <span class="kw">q05</span> <span class="kw">=</span> <span class="no">q05</span>, <span class="kw">q95</span> <span class="kw">=</span> <span class="no">q95</span>),
                                                                    <span class="kw">function</span>(<span class="no">f</span>) <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">.SD</span>, <span class="no">f</span>)
                                   )),
                                   <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span>(<span class="no">data_national</span>)),
                                   <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>)]

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_sim_seasonal_data_national</span>,<span class="fl">5</span>)
<span class="co">#&gt;       season                        attr                    tag median.exp_attr</span>
<span class="co">#&gt; 1: 2009/2010 exp_mort_temperature_high=0 aggregated_from_county       199.96456</span>
<span class="co">#&gt; 2: 2009/2010 exp_mort_temperature_high=0                 nation        59.76135</span>
<span class="co">#&gt; 3: 2009/2010  exp_mort_pr100_ili_lag_1=0 aggregated_from_county       657.03001</span>
<span class="co">#&gt; 4: 2009/2010  exp_mort_pr100_ili_lag_1=0                 nation       280.50216</span>
<span class="co">#&gt; 5: 2010/2011 exp_mort_temperature_high=0 aggregated_from_county       482.87878</span>
<span class="co">#&gt;    median.exp_irr q05.exp_attr q05.exp_irr q95.exp_attr q95.exp_irr</span>
<span class="co">#&gt; 1:       1.007999    189.52015    1.007593     210.8823    1.008424</span>
<span class="co">#&gt; 2:       1.002413     55.42205    1.002251      63.7861    1.002564</span>
<span class="co">#&gt; 3:       1.026715    542.27985    1.021921     767.3054    1.031369</span>
<span class="co">#&gt; 4:       1.011473    125.21106    1.005055     436.2021    1.017787</span>
<span class="co">#&gt; 5:       1.011290    457.56250    1.010712     509.2631    1.011889</span></pre></body></html></div>
<p>We can now see that we have confidance intervals and estimates for both the attributable deaths and the incident risk ratio for all exposures.</p>
</div>
<div id="plot-to-compare-the-national-with-the-aggregated-county-to-natoinal-model" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-to-compare-the-national-with-the-aggregated-county-to-natoinal-model" class="anchor"></a>Plot to compare the national with the aggregated county to natoinal model</h2>
<p>To be able to compare the two models we make a pointrange plot using ggplot2.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">aggregated_sim_seasonal_data_national</span>[<span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
                       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">season</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">median.exp_attr</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">tag</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">tag</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">season</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">median.exp_attr</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">q05.exp_attr</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">q95.exp_attr</span>), <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>(<span class="kw">width</span> <span class="kw">=</span> <span class="fl">0.3</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Attributable mortality due to ILI in Norway according to 2 models"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="st">"Estimated attributable mortality"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>),<span class="kw">axis.title.x</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">caption</span> <span class="kw">=</span> <span class="kw pkg">glue</span><span class="kw ns">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">" Aggregated county model: Attributable mortality modeled on a county level before beeing aggregated up to a national level.\n National model: Attributable mortality modeled on a national level.\n Folkehelseinstituttet 14.07.2020"</span>))
<span class="no">q</span></pre></body></html></div>
<p><img src="intro_files/figure-html/unnamed-chunk-19-1.png" width="576"></p>
</div>
</div>
<div id="aggregating-the-county-model-to-compare-seasons-" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregating-the-county-model-to-compare-seasons-" class="anchor"></a>Aggregating the county model to compare seasons.</h1>
<p>As a contrast to what we did in the section about comparing the national data to data aggregated from county to national level, we now want to keep the information on a weekly basis.</p>
<p>Hence the aggregation is done in the same way as before with the exeption of including <em>x</em> and <em>week</em> in the keyby funciton. <!-- is keyby a function? --></p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">aggregated_county_to_nation</span> <span class="kw">&lt;-</span>  <span class="no">est_attrib_county_long</span>[, <span class="fu">.</span>(
  <span class="kw">exp_mort_observed</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">exp_mort_observed</span>),
  <span class="kw">value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">value</span>),
  <span class="kw">deaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">deaths</span>)
), <span class="kw">keyby</span> <span class="kw">=</span> <span class="fu">.</span>(<span class="no">season</span>, <span class="no">x</span>, <span class="no">week</span>, <span class="no">attr</span>, <span class="no">sim_id</span>)]

<span class="no">aggregated_county_to_nation</span>[, <span class="no">exp_attr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span> - <span class="no">value</span>)]
<span class="no">aggregated_county_to_nation</span>[, <span class="no">exp_irr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span>/<span class="no">value</span>)]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_county_to_nation</span>,<span class="fl">5</span>)
<span class="co">#&gt;       season    x week                        attr sim_id exp_mort_observed</span>
<span class="co">#&gt; 1: 2009/2010 23.5   53 exp_mort_temperature_high=0      1          854.1494</span>
<span class="co">#&gt; 2: 2009/2010 23.5   53 exp_mort_temperature_high=0      2          871.5726</span>
<span class="co">#&gt; 3: 2009/2010 23.5   53 exp_mort_temperature_high=0      3          859.5299</span>
<span class="co">#&gt; 4: 2009/2010 23.5   53 exp_mort_temperature_high=0      4          860.1416</span>
<span class="co">#&gt; 5: 2009/2010 23.5   53 exp_mort_temperature_high=0      5          851.4509</span>
<span class="co">#&gt;       value deaths exp_attr exp_irr</span>
<span class="co">#&gt; 1: 854.1494    840        0       1</span>
<span class="co">#&gt; 2: 871.5726    840        0       1</span>
<span class="co">#&gt; 3: 859.5299    840        0       1</span>
<span class="co">#&gt; 4: 860.1416    840        0       1</span>
<span class="co">#&gt; 5: 851.4509    840        0       1</span></pre></body></html></div>
<p>We observe that the <em>location_code</em> is aggregated away but we still have both <em>x</em> and <em>week</em></p>
<p>Again we compute the quantiles.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r">
<span class="no">col_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">aggregated_county_to_nation</span>)
<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span>(<span class="no">aggregated_county_to_nation</span>, <span class="no">col_names</span>[!<span class="no">col_names</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>,<span class="st">"sim_id"</span>, <span class="st">"exposures"</span>, <span class="st">"exp_mort_observed"</span>, <span class="st">"value"</span>)])

<span class="no">aggregated_county_to_nation_weekly</span> <span class="kw">&lt;-</span> <span class="no">aggregated_county_to_nation</span>[,
              <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu">.</span>(<span class="kw">median</span> <span class="kw">=</span> <span class="no">median</span>, <span class="kw">q05</span> <span class="kw">=</span> <span class="no">q05</span>, <span class="kw">q95</span> <span class="kw">=</span> <span class="no">q95</span>),
                                               <span class="kw">function</span>(<span class="no">f</span>) <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">.SD</span>, <span class="no">f</span>)
              )),
              <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span>(<span class="no">aggregated_county_to_nation</span>)),
              <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>)]</pre></body></html></div>
<p>To be able to visualise the attributable deaths cumulativ we add this feature to the dataset using the cumsum function.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">aggregated_county_to_nation_weekly</span>[, <span class="no">cumsum</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="no">median.exp_attr</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fu">.</span>( <span class="no">attr</span>, <span class="no">season</span>)]
<span class="no">aggregated_county_to_nation_weekly</span>[, <span class="no">cumsum_q05</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="no">q05.exp_attr</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fu">.</span>( <span class="no">attr</span>, <span class="no">season</span>)]
<span class="no">aggregated_county_to_nation_weekly</span>[, <span class="no">cumsum_q95</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="no">q95.exp_attr</span>), <span class="kw">by</span> <span class="kw">=</span> <span class="fu">.</span>( <span class="no">attr</span>, <span class="no">season</span>)]

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_county_to_nation_weekly</span>, <span class="fl">5</span>)
<span class="co">#&gt;       season    x week                        attr deaths median.exp_attr</span>
<span class="co">#&gt; 1: 2009/2010 23.5   53 exp_mort_temperature_high=0    840         0.00000</span>
<span class="co">#&gt; 2: 2009/2010 23.5   53  exp_mort_pr100_ili_lag_1=0    840         0.00000</span>
<span class="co">#&gt; 3: 2009/2010 24.0    1 exp_mort_temperature_high=0    897         0.00000</span>
<span class="co">#&gt; 4: 2009/2010 24.0    1  exp_mort_pr100_ili_lag_1=0    897        46.30156</span>
<span class="co">#&gt; 5: 2009/2010 25.0    2 exp_mort_temperature_high=0    861         0.00000</span>
<span class="co">#&gt;    median.exp_irr q05.exp_attr q05.exp_irr q95.exp_attr q95.exp_irr   cumsum</span>
<span class="co">#&gt; 1:       1.000000      0.00000    1.000000      0.00000    1.000000  0.00000</span>
<span class="co">#&gt; 2:       1.000000      0.00000    1.000000      0.00000    1.000000  0.00000</span>
<span class="co">#&gt; 3:       1.000000      0.00000    1.000000      0.00000    1.000000  0.00000</span>
<span class="co">#&gt; 4:       1.053669     38.13629    1.043961     54.08895    1.063161 46.30156</span>
<span class="co">#&gt; 5:       1.000000      0.00000    1.000000      0.00000    1.000000  0.00000</span>
<span class="co">#&gt;    cumsum_q05 cumsum_q95</span>
<span class="co">#&gt; 1:    0.00000    0.00000</span>
<span class="co">#&gt; 2:    0.00000    0.00000</span>
<span class="co">#&gt; 3:    0.00000    0.00000</span>
<span class="co">#&gt; 4:   38.13629   54.08895</span>
<span class="co">#&gt; 5:    0.00000    0.00000</span></pre></body></html></div>
<p>We now have the quantiles and median as before as well as the cumulativ values on a seasonal basis.</p>
<div id="cumulativ-plot-for-attributable-mortality-due-to-ili" class="section level2">
<h2 class="hasAnchor">
<a href="#cumulativ-plot-for-attributable-mortality-due-to-ili" class="anchor"></a>Cumulativ plot for attributable mortality due to ILI</h2>
<p>We use ggplot2s geom_line and geom_ribbon to nicely visualize the estimates of attributable mortality for the diferent seasons and adding the ninty percent confidance interval to the last season.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="no">q</span> <span class="kw">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">season</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2015/2016"</span>, <span class="st">"2016/2017"</span>, <span class="st">"2017/2018"</span>, <span class="st">"2018/2019"</span>,<span class="st">"2019/2020"</span>) <span class="kw">&amp;</span> <span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>], <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cumsum</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">season</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">season</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">season</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>()
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">season</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"2019/2020"</span>) <span class="kw">&amp;</span> <span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">cumsum_q05</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">cumsum_q95</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.4</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="fl">NA</span>)

<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="st">"Estimated attributable mortality"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Estimated mortality due to ILI in Norway"</span>)
<span class="no">q</span></pre></body></html></div>
<p><img src="intro_files/figure-html/unnamed-chunk-23-1.png" width="576"></p>
</div>
<div id="plot-for-attributable-mortality-due-to-ili" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-for-attributable-mortality-due-to-ili" class="anchor"></a>Plot for attributable mortality due to ILI</h2>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">cumsum</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">season</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">season</span> <span class="kw">!=</span> <span class="st">"2019/2020"</span> <span class="kw">&amp;</span><span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">median.exp_attr</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">season</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"grey"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">season</span> <span class="kw">==</span> <span class="st">"2019/2020"</span> <span class="kw">&amp;</span><span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">median.exp_attr</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">season</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_weekly</span>[<span class="no">season</span> <span class="kw">==</span> <span class="st">"2019/2020"</span> <span class="kw">&amp;</span><span class="no">attr</span> <span class="kw">==</span> <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>],
              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">q05.exp_attr</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">q95.exp_attr</span>), <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"blue"</span>, <span class="kw">alpha</span><span class="kw">=</span><span class="fl">0.4</span>)

<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="st">"Estimated attributable mortality"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Estimated mortality due to ILI per week"</span>)
<span class="no">q</span></pre></body></html></div>
<p><img src="intro_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
</div>
</div>
<div id="incident-rate-ratio" class="section level1">
<h1 class="hasAnchor">
<a href="#incident-rate-ratio" class="anchor"></a>Incident rate ratio</h1>
<p>Untill now we have focused moslty on attributable mortalities. Now we will take a look at how to cumpute the incident rate ratio for <em>pr100_ili_lag_1</em>. Do do this we will use the fit made by fit_attrib on the county dataset but we will change the values for <em>pr100_ili_lag_1</em> to 1.</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">data_fake_county_irr</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span>(<span class="no">data_fake_county</span>)
<span class="no">data_fake_county_irr</span>[, <span class="no">pr100_ili_lag_1</span> <span class="kw">:=</span> <span class="fl">1</span>]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">data_fake_county_irr</span>, <span class="fl">5</span>)
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 1.9011202</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.9246802</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.1543753</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.3947382</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.7962545</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths</span>
<span class="co">#&gt; 1:               1  2.39975858                0    108</span>
<span class="co">#&gt; 2:               1  1.90199543                0    104</span>
<span class="co">#&gt; 3:               1 -6.82610667                0    107</span>
<span class="co">#&gt; 4:               1 -4.28041946                0    117</span>
<span class="co">#&gt; 5:               1  0.07310006                0    113</span></pre></body></html></div>
<p>Then we can set the referance value to zero and hence optain the risk ratio for the given exposures.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">exposures_irr</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">pr100_ili_lag_1</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
<p>Now we use est_attrib to create the simmulations.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r">est_attrib_sim_county_irr &lt;- attrib::est_attrib(fit_county, 
                                        data_fake_county_irr, 
                                        exposures = exposures_irr)
#&gt; 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |======================================================================| 100%
head(est_attrib_sim_county_irr, 5)
#&gt;    location_code week    season year    yrwk  x    pop pr100_ili
#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 1.9011202
#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.9246802
#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.1543753
#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.3947382
#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.7962545
#&gt;    pr100_ili_lag_1 temperature temperature_high deaths id sim_id
#&gt; 1:               1  2.39975858                0    108  1      1
#&gt; 2:               1  1.90199543                0    104  2      1
#&gt; 3:               1 -6.82610667                0    107  3      1
#&gt; 4:               1 -4.28041946                0    117  4      1
#&gt; 5:               1  0.07310006                0    113  5      1
#&gt;    exp_mort_observed exp_mort_pr100_ili_lag_1=0
#&gt; 1:          115.7356                   110.0756
#&gt; 2:          116.0123                   111.7927
#&gt; 3:          115.1126                   110.0150
#&gt; 4:          115.4902                   109.8399
#&gt; 5:          115.1866                   110.0492</pre></body></html></div>
<p>We see we have obtained values for the referance of the exposure in the same way as before. The difference now is that we changed the dataset before running <em>est_attrib</em> meaning the <em>exp_mort_observed</em> will now deviate a from the true number of deaths and be the expected number of deaths given <em>pr100_ili_lag_1</em> equall to 1.</p>
<p>The next step is as before to aggregate from a county, weekly to a national seasonal dataset as well ass adding the values for the incident risk ratio to the column <em>exp_irr</em>.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">aggregated_county_to_nation_sim_irr</span> <span class="kw">&lt;-</span>  <span class="no">est_attrib_sim_county_irr</span>[, <span class="fu">.</span>(
  <span class="kw">exp_mort_observed</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">exp_mort_observed</span>),
  <span class="st">"exp_mort_pr100_ili_lag_1=0"</span><span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">`exp_mort_pr100_ili_lag_1=0`</span>),
  <span class="kw">deaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">deaths</span>)
), <span class="kw">keyby</span> <span class="kw">=</span> <span class="fu">.</span>(<span class="no">season</span>, <span class="no">sim_id</span>)]</pre></body></html></div>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">aggregated_county_to_nation_sim_irr</span>[, <span class="no">exp_irr</span><span class="kw">:=</span> (<span class="no">exp_mort_observed</span>/<span class="no">`exp_mort_pr100_ili_lag_1=0`</span>
)]
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">aggregated_county_to_nation_sim_irr</span>,<span class="fl">5</span>)
<span class="co">#&gt;       season sim_id exp_mort_observed exp_mort_pr100_ili_lag_1=0 deaths</span>
<span class="co">#&gt; 1: 2009/2010      1          25545.40                   24296.10  25481</span>
<span class="co">#&gt; 2: 2009/2010      2          25487.67                   24554.40  25481</span>
<span class="co">#&gt; 3: 2009/2010      3          25571.36                   24409.18  25481</span>
<span class="co">#&gt; 4: 2009/2010      4          25566.21                   24654.72  25481</span>
<span class="co">#&gt; 5: 2009/2010      5          25431.35                   24482.46  25481</span>
<span class="co">#&gt;     exp_irr</span>
<span class="co">#&gt; 1: 1.051419</span>
<span class="co">#&gt; 2: 1.038008</span>
<span class="co">#&gt; 3: 1.047612</span>
<span class="co">#&gt; 4: 1.036970</span>
<span class="co">#&gt; 5: 1.038758</span></pre></body></html></div>
<p>Now we can compute the quantiles.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r">
<span class="no">col_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">aggregated_county_to_nation_sim_irr</span>)
<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span>(<span class="no">aggregated_county_to_nation_sim_irr</span>, <span class="no">col_names</span>[!<span class="no">col_names</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="st">"exp_irr"</span>,<span class="st">"sim_id"</span>, <span class="st">"exp_mort_observed"</span>, <span class="st">"exp_mort_pr100_ili_lag_1=0"</span>)])

<span class="no">aggregated_county_to_nation_irr</span> <span class="kw">&lt;-</span> <span class="no">aggregated_county_to_nation_sim_irr</span>[,
              <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">recursive</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu">.</span>(<span class="kw">median</span> <span class="kw">=</span> <span class="no">median</span>, <span class="kw">q05</span> <span class="kw">=</span> <span class="no">q05</span>, <span class="kw">q95</span> <span class="kw">=</span> <span class="no">q95</span>),
                                               <span class="kw">function</span>(<span class="no">f</span>) <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">.SD</span>, <span class="no">f</span>)
              )),
              <span class="kw">by</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span>(<span class="no">aggregated_county_to_nation_sim_irr</span>)),
              <span class="kw">.SDcols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"exp_irr"</span>)]
<span class="no">aggregated_county_to_nation_irr</span>[, <span class="no">tag</span> <span class="kw">:=</span> <span class="st">"aggregated"</span>]

<span class="no">aggregated_county_to_nation_irr</span>
<span class="co">#&gt;        season deaths median.exp_irr q05.exp_irr q95.exp_irr        tag</span>
<span class="co">#&gt;  1: 2009/2010  25481       1.039450    1.032826    1.046513 aggregated</span>
<span class="co">#&gt;  2: 2010/2011  43371       1.034971    1.028498    1.042000 aggregated</span>
<span class="co">#&gt;  3: 2011/2012  43130       1.038001    1.031101    1.045449 aggregated</span>
<span class="co">#&gt;  4: 2012/2013  43305       1.039336    1.032972    1.047079 aggregated</span>
<span class="co">#&gt;  5: 2013/2014  43341       1.039158    1.032479    1.045997 aggregated</span>
<span class="co">#&gt;  6: 2014/2015  42989       1.037555    1.030981    1.043938 aggregated</span>
<span class="co">#&gt;  7: 2015/2016  43885       1.038428    1.031396    1.045836 aggregated</span>
<span class="co">#&gt;  8: 2016/2017  43384       1.036402    1.029025    1.043798 aggregated</span>
<span class="co">#&gt;  9: 2017/2018  43715       1.038237    1.031261    1.045065 aggregated</span>
<span class="co">#&gt; 10: 2018/2019  42892       1.041372    1.034857    1.048919 aggregated</span>
<span class="co">#&gt; 11: 2019/2020  43108       1.040028    1.033017    1.047433 aggregated</span>
<span class="co">#&gt; 12: 2020/2021  18877       1.040982    1.034481    1.048179 aggregated</span></pre></body></html></div>
<p>Now we compare the resulting values for irr with the ones obtained by coef(fit_county)$season and the 90 credible interval computed manually using the standard deviation given by summary(fit_county) for <em>pr100_ili_lag_1</em>.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">coef_fit_county</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit_county</span>)$<span class="no">season</span>)
<span class="no">col_names_coef</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"pr100_ili_lag_1"</span>)
<span class="no">coef_irr_data</span> <span class="kw">&lt;-</span> <span class="no">coef_fit_county</span>[, <span class="no">..col_names_coef</span>]
<span class="no">coef_irr_data</span>[, <span class="no">irr</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">pr100_ili_lag_1</span>)]
<span class="no">coef_irr_data</span>[, <span class="no">q05</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">pr100_ili_lag_1</span> - <span class="fl">1.645</span> *<span class="fl">0.003761</span>)]  <span class="co"># 0.003761 is the standard deviation from coef(fit_county)</span>
<span class="no">coef_irr_data</span>[, <span class="no">q95</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">pr100_ili_lag_1</span> + <span class="fl">1.645</span> *<span class="fl">0.003761</span>)]
<span class="no">coef_irr_data</span>[, <span class="no">tag</span> <span class="kw">:=</span> <span class="st">"from_coef"</span>]
<span class="no">coef_irr_data</span>
<span class="co">#&gt;     pr100_ili_lag_1      irr      q05      q95       tag</span>
<span class="co">#&gt;  1:      0.03903384 1.039806 1.033392 1.046259 from_coef</span>
<span class="co">#&gt;  2:      0.03486914 1.035484 1.029098 1.041910 from_coef</span>
<span class="co">#&gt;  3:      0.03770888 1.038429 1.032024 1.044873 from_coef</span>
<span class="co">#&gt;  4:      0.03908609 1.039860 1.033446 1.046313 from_coef</span>
<span class="co">#&gt;  5:      0.03863077 1.039387 1.032976 1.045837 from_coef</span>
<span class="co">#&gt;  6:      0.03706589 1.037761 1.031361 1.044202 from_coef</span>
<span class="co">#&gt;  7:      0.03795133 1.038681 1.032274 1.045127 from_coef</span>
<span class="co">#&gt;  8:      0.03601079 1.036667 1.030273 1.043101 from_coef</span>
<span class="co">#&gt;  9:      0.03787166 1.038598 1.032192 1.045043 from_coef</span>
<span class="co">#&gt; 10:      0.04111602 1.041973 1.035546 1.048439 from_coef</span>
<span class="co">#&gt; 11:      0.03946076 1.040250 1.033834 1.046705 from_coef</span>
<span class="co">#&gt; 12:      0.04052015 1.041352 1.034929 1.047815 from_coef</span></pre></body></html></div>
<p>Add the correct seasons to the data.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">coef_irr_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">season</span> <span class="kw">=</span> <span class="no">aggregated_county_to_nation_irr</span>$<span class="no">season</span>, <span class="no">coef_irr_data</span>)
<span class="no">coef_irr_data</span>
<span class="co">#&gt;        season pr100_ili_lag_1      irr      q05      q95       tag</span>
<span class="co">#&gt;  1: 2009/2010      0.03903384 1.039806 1.033392 1.046259 from_coef</span>
<span class="co">#&gt;  2: 2010/2011      0.03486914 1.035484 1.029098 1.041910 from_coef</span>
<span class="co">#&gt;  3: 2011/2012      0.03770888 1.038429 1.032024 1.044873 from_coef</span>
<span class="co">#&gt;  4: 2012/2013      0.03908609 1.039860 1.033446 1.046313 from_coef</span>
<span class="co">#&gt;  5: 2013/2014      0.03863077 1.039387 1.032976 1.045837 from_coef</span>
<span class="co">#&gt;  6: 2014/2015      0.03706589 1.037761 1.031361 1.044202 from_coef</span>
<span class="co">#&gt;  7: 2015/2016      0.03795133 1.038681 1.032274 1.045127 from_coef</span>
<span class="co">#&gt;  8: 2016/2017      0.03601079 1.036667 1.030273 1.043101 from_coef</span>
<span class="co">#&gt;  9: 2017/2018      0.03787166 1.038598 1.032192 1.045043 from_coef</span>
<span class="co">#&gt; 10: 2018/2019      0.04111602 1.041973 1.035546 1.048439 from_coef</span>
<span class="co">#&gt; 11: 2019/2020      0.03946076 1.040250 1.033834 1.046705 from_coef</span>
<span class="co">#&gt; 12: 2020/2021      0.04052015 1.041352 1.034929 1.047815 from_coef</span></pre></body></html></div>
<p>Rbindlist the two datasets together.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">total_data_irr</span> <span class="kw">&lt;-</span> <span class="kw pkg">data.table</span><span class="kw ns">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">coef_irr_data</span>, <span class="no">aggregated_county_to_nation_irr</span>), <span class="kw">use.names</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">total_data_irr</span>[, <span class="no">pr100_ili_lag_1</span> <span class="kw">:=</span> <span class="kw">NULL</span>]
<span class="no">total_data_irr</span>
<span class="co">#&gt;        season      irr      q05      q95        tag</span>
<span class="co">#&gt;  1: 2009/2010 1.039806 1.033392 1.046259  from_coef</span>
<span class="co">#&gt;  2: 2010/2011 1.035484 1.029098 1.041910  from_coef</span>
<span class="co">#&gt;  3: 2011/2012 1.038429 1.032024 1.044873  from_coef</span>
<span class="co">#&gt;  4: 2012/2013 1.039860 1.033446 1.046313  from_coef</span>
<span class="co">#&gt;  5: 2013/2014 1.039387 1.032976 1.045837  from_coef</span>
<span class="co">#&gt;  6: 2014/2015 1.037761 1.031361 1.044202  from_coef</span>
<span class="co">#&gt;  7: 2015/2016 1.038681 1.032274 1.045127  from_coef</span>
<span class="co">#&gt;  8: 2016/2017 1.036667 1.030273 1.043101  from_coef</span>
<span class="co">#&gt;  9: 2017/2018 1.038598 1.032192 1.045043  from_coef</span>
<span class="co">#&gt; 10: 2018/2019 1.041973 1.035546 1.048439  from_coef</span>
<span class="co">#&gt; 11: 2019/2020 1.040250 1.033834 1.046705  from_coef</span>
<span class="co">#&gt; 12: 2020/2021 1.041352 1.034929 1.047815  from_coef</span>
<span class="co">#&gt; 13: 2009/2010 1.039450 1.032826 1.046513 aggregated</span>
<span class="co">#&gt; 14: 2010/2011 1.034971 1.028498 1.042000 aggregated</span>
<span class="co">#&gt; 15: 2011/2012 1.038001 1.031101 1.045449 aggregated</span>
<span class="co">#&gt; 16: 2012/2013 1.039336 1.032972 1.047079 aggregated</span>
<span class="co">#&gt; 17: 2013/2014 1.039158 1.032479 1.045997 aggregated</span>
<span class="co">#&gt; 18: 2014/2015 1.037555 1.030981 1.043938 aggregated</span>
<span class="co">#&gt; 19: 2015/2016 1.038428 1.031396 1.045836 aggregated</span>
<span class="co">#&gt; 20: 2016/2017 1.036402 1.029025 1.043798 aggregated</span>
<span class="co">#&gt; 21: 2017/2018 1.038237 1.031261 1.045065 aggregated</span>
<span class="co">#&gt; 22: 2018/2019 1.041372 1.034857 1.048919 aggregated</span>
<span class="co">#&gt; 23: 2019/2020 1.040028 1.033017 1.047433 aggregated</span>
<span class="co">#&gt; 24: 2020/2021 1.040982 1.034481 1.048179 aggregated</span>
<span class="co">#&gt;        season      irr      q05      q95        tag</span></pre></body></html></div>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">q</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">total_data_irr</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">season</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">tag</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">tag</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">irr</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">q05</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">q95</span>), <span class="kw">position</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>(<span class="kw">width</span> <span class="kw">=</span> <span class="fl">0.3</span>))
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> +  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>),<span class="kw">axis.title.x</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="st">"Incident risk ratio"</span>)
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="no">q</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Incident risk ratio for ILI per season"</span>)
<span class="no">q</span></pre></body></html></div>
<p><img src="intro_files/figure-html/unnamed-chunk-34-1.png" width="576"></p>
<p>As we can see these intervals are very similar.</p>
<p>The benefit of the aggregated aproach is that this prosess will be equally easy no matter the complexity of what we want to compute the irr for. We do not have ot take the variance covariance matrix in to account at any stage or manually compute credible intervals.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Richard White, Aurora Hofman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
